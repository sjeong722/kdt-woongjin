# 📉 분석 딥다이브: 역별 지연 변동성 및 분포 분석

이 문서는 지하철 지연 데이터를 통해 **'시간 흐름에 따른 지연 패턴'**과 **'지연/조기 도착의 통계적 분포'**를 분석하기 위한 전용 SQL 쿼리와 가이드를 제공합니다.

---

## 1. 분석의 목적 및 목표
두 가지 시각화를 각각의 전용 코드로 분리하여, Redash 설정 오류 없이 정확한 분석 결과를 도출합니다.

*   **옵션 A (산점도)**: 개별 열차의 지연 흐름을 파악하여 특정 시간대의 병목 현상을 진단합니다.
*   **옵션 B (분포도)**: 노선 전체의 시간 준수 신뢰도(첨도/왜도)를 통계적으로 분석합니다.

---

## 2. 시각화별 전용 SQL 및 설정

### 💡 옵션 A: 시간대별 지연 산점도 (상황 모니터링용)
> **"어느 시간대에 지연 산맥이 형성되는가?"**

#### 🔍 전용 SQL (산점도 최적화)
```sql
SELECT 
    scheduled_arrival_text, 
    line_name,
    CASE WHEN up_down::text = '0' THEN '상행/내선' ELSE '하행/외선' END AS direction,
    train_code_num AS "열차번호",
    dest_station_name AS "행선지",
    -- 산점도 가독성을 위해 조기 도착은 0분으로 처리
    CASE 
        WHEN delay_duration > interval '0 seconds' 
        THEN ROUND((EXTRACT(EPOCH FROM delay_duration) / 60)::numeric, 1)
        ELSE 0 
    END AS delay_minutes
FROM table_redash_history
WHERE station_name = '{{ station_name }}'
  AND line_name = '{{ line_name }}'
  AND up_down::text = '{{ direction_0_or_1 }}'
  AND created_date = CURRENT_DATE
ORDER BY scheduled_arrival_text;
```

#### 🎨 Redash 설정 (산점도)
| 설정 항목 | 선택 값 | 설명 |
| :--- | :--- | :--- |
| **Visualization Type** | `Chart` | |
| **Chart Type** | `Scatter` | 점으로 분포 표시 |
| **X Column** | `scheduled_arrival_text` | x축은 시간의 흐름 |
| **Y Columns** | `delay_minutes` | 위로 높을수록 지연 심함 |
| **Group by** | `direction` | 상하행 색상 구분 |

---

### 💡 옵션 B: 지연 시간 통계 분포 (신뢰도 진단용)
> **"일찍 오는 차와 늦는 차의 비율 및 쏠림 현상 확인"**

#### 🔍 전용 SQL (통계 집계 완료 버전)
*Redash의 집계 기능 없이도 바로 막대 그래프를 그릴 수 있도록 SQL에서 미리 빈도수(Count)를 계산합니다.*

```sql
SELECT 
    -- 1분 단위로 지연 시간을 묶음 (조기 도착 음수 포함)
    ROUND((EXTRACT(EPOCH FROM delay_duration) / 60)::numeric, 0) AS delay_group,
    -- 해당 시간대의 열차 대수 직접 집계
    COUNT(*) AS train_count
FROM table_redash_history
WHERE station_name = '{{ station_name }}'
  AND line_name = '{{ line_name }}'
  AND up_down::text = '{{ direction_0_or_1 }}'
  AND created_date = CURRENT_DATE
GROUP BY 1
ORDER BY 1;
```

#### 🎨 Redash 설정 (분포도)
| 설정 항목 | 선택 값 | 설명 |
| :--- | :--- | :--- |
| **Visualization Type** | `Chart` | |
| **Chart Type** | `Bar` | 막대 그래프 (히스토그램 형태) |
| **X Column** | `delay_group` | 지연 시간 (분 단위) |
| **Y Columns** | `train_count` | **(이제 드롭다운에 바로 나타납니다!)** |

---

## 🎨 전문가급 가독성을 위한 꾸미기 디테일 (Aesthetics)
리데쉬에서 다음 설정들을 추가하면 대시보드의 퀄리티가 훨씬 높아집니다.

### 1. 색상의 심리학 (Series 탭)
*   **방향별 고유색**: `direction` 그룹별로 색상을 직접 지정하세요.
    *   **상행/내선**: 파란색 계열 (예: `#3498db`)
    *   **하행/외선**: 주황/빨간색 계열 (예: `#e67e22`)
*   **포인트 크기**: 산점도에서 **Point Size**를 `2` 또는 `3`으로 낮추면 더 세련되어 보입니다.

### 2. 레이블 명칭 변경 (X/Y Axis 탭)
*   **Y Axis Name**: `지연 시간 (분)` 또는 `열차 수 (대)` 등으로 변경하세요.
*   **X Axis Name**: `예정 시각` 또는 `지연 정도` 등으로 변경하세요.

---

## 🏛️ 대시보드 배치 최종 권고
하나의 화면에 **산점도(옵션 A)**와 **분포도(옵션 B)**를 좌우로 나란히 배치해 보세요. 
좌측에서 "어느 시간대에 문제가 터졌나"를 보고, 우측에서 "이 노선의 전반적인 시간 정확도가 이렇구나"라고 결론을 내리는 것이 최고의 분석 흐름입니다.
