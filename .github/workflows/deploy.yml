name: Deploy DAGs to GCP VM

on:
  push:
    branches:
      - main  # 배포를 원하는 브랜치명으로 수정하세요

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate DAG IDs
        run: |
          cat <<EOF > validate_dags.py
          import os
          import sys
          import re

          dags_root = 'dags'
          failed = False

          if not os.path.exists(dags_root):
              print("dags directory not found")
              sys.exit(0)

          for nickname in os.listdir(dags_root):
              nickname_path = os.path.join(dags_root, nickname)
              if not os.path.isdir(nickname_path) or nickname.startswith('.') or nickname == '__pycache__':
                  continue

              print(f"Checking DAGs for nickname: {nickname}")

              for root, dirs, files in os.walk(nickname_path):
                  for file in files:
                      if file.endswith('.py'):
                          file_path = os.path.join(root, file)
                          try:
                              with open(file_path, 'r', encoding='utf-8') as f:
                                  content = f.read()

                              matches = re.finditer(r'dag_id\s*=\s*([\'\"])(.*?)\1', content)

                              for match in matches:
                                  dag_id_val = match.group(2)
                                  if nickname not in dag_id_val:
                                      print(f"::error file={file_path}::Invalid dag_id '{dag_id_val}'. It must contain the nickname '{nickname}'.")
                                      failed = True
                          except Exception as e:
                              print(f"::warning::Could not check {file_path}: {e}")

          if failed:
              sys.exit(1)
          EOF

          python3 validate_dags.py

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 34.56.112.10
          username: datapopcorn
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # 1. 유저님이 선호하는 DAGs 폴더로 이동
            cd ~/kdt-woongjin
            
            # 2. 만약 해당 폴더가 git 레포가 아니라면 초기 설정
            if [ ! -d ".git" ]; then
              git init
              git remote add origin https://github.com/inyounglee-datapopcorn/kdt-woongjin.git
            fi
            
            # 3. 최신 코드 가져오기 (main 브랜치 기준)
            git fetch --all
            git reset --hard origin/main
            
            # 4. 권한 설정 (Docker 컨테이너가 파일을 읽을 수 있도록 허용)
            sudo chown -R datapopcorn:datapopcorn ~/kdt-woongjin
